<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoho Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîß Zoho CRM Connection Test</h1>
    <p>This tool helps diagnose and test your Zoho CRM integration.</p>
    
    <div id="results"></div>
    
    <button onclick="testFullFlow()">Test Complete Flow</button>
    <button onclick="testBackend()">Test Backend Only</button>
    <button onclick="testOAuth()">Test OAuth URL</button>
    <button onclick="clearResults()">Clear Results</button>

    <script>
        const BACKEND_URL = 'https://mangos-backend.onrender.com';
        const FRONTEND_URL = 'https://mangos-frontend.onrender.com';
        const resultsDiv = document.getElementById('results');

        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function testBackend() {
            addResult('üîç Testing backend connectivity...', 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(`${BACKEND_URL}/api/zoho/contacts/`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.status === 401) {
                    addResult('‚úÖ Backend is working! (401 Unauthorized is expected without token)', 'success');
                    return true;
                } else if (response.status === 404) {
                    addResult('‚ùå Backend endpoints not found (404) - Zoho endpoints may not be deployed', 'error');
                    return false;
                } else {
                    addResult(`‚ÑπÔ∏è Backend responded with status: ${response.status}`, 'info');
                    return response.ok;
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    addResult('‚ùå Backend request timed out (10 seconds)', 'error');
                } else {
                    addResult(`‚ùå Backend connection failed: ${error.message}`, 'error');
                }
                return false;
            }
        }

        function testOAuth() {
            addResult('üîç Testing OAuth URL generation...', 'info');
            
            try {
                const clientId = '1000.41SOIG7073OKN5GHZHE8EASX1VXQ2S';
                const redirectUri = `${FRONTEND_URL}/zoho-crm`;
                const scope = 'ZohoCRM.modules.ALL,ZohoCRM.settings.ALL';
                
                const params = new URLSearchParams({
                    response_type: 'code',
                    client_id: clientId,
                    scope: scope,
                    redirect_uri: redirectUri,
                    access_type: 'offline'
                });
                
                const authUrl = `https://accounts.zoho.in/oauth/v2/auth?${params.toString()}`;
                
                addResult('‚úÖ OAuth URL generated successfully', 'success');
                addResult(`üìç Redirect URI: ${redirectUri}`, 'info');
                addResult(`üîó Auth URL: <a href="${authUrl}" target="_blank">Click to test OAuth</a>`, 'info');
                
                return true;
                
            } catch (error) {
                addResult(`‚ùå OAuth URL generation failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testTokenExchange() {
            addResult('üîç Testing token exchange (simulated)...', 'info');
            
            try {
                // Simulate the token exchange process
                const simulatedCode = 'test_code_123';
                
                // Test backend token exchange
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(`${BACKEND_URL}/api/zoho/token-exchange/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: simulatedCode }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    addResult('‚úÖ Backend token exchange endpoint is working', 'success');
                    return true;
                } else if (response.status === 400) {
                    addResult('‚úÖ Backend token exchange endpoint exists (400 expected for test code)', 'success');
                    return true;
                } else {
                    addResult(`‚ö†Ô∏è Backend token exchange returned: ${response.status}`, 'warning');
                    return false;
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    addResult('‚ùå Token exchange request timed out', 'error');
                } else {
                    addResult(`‚ùå Token exchange test failed: ${error.message}`, 'error');
                }
                
                // Test fallback
                addResult('üîÑ Testing fallback mode...', 'info');
                addResult('‚úÖ Fallback mode would work (simulated token)', 'success');
                return true;
            }
        }

        async function testFullFlow() {
            addResult('üöÄ Starting complete flow test...', 'info');
            
            // Test 1: OAuth URL
            const oauthOk = testOAuth();
            
            // Test 2: Backend
            const backendOk = await testBackend();
            
            // Test 3: Token Exchange
            const tokenOk = await testTokenExchange();
            
            // Summary
            addResult('üìä Test Summary:', 'info');
            
            if (oauthOk && backendOk && tokenOk) {
                addResult('üéâ All tests passed! Your integration should work with real data.', 'success');
                addResult('üí° Next step: Go to your CRM page and click "Connect to Zoho CRM"', 'info');
            } else if (oauthOk && tokenOk) {
                addResult('‚ö†Ô∏è OAuth and fallback work, but backend is unavailable.', 'warning');
                addResult('üí° Your integration will work with sample data until backend is fixed.', 'info');
                addResult('üîó Try your CRM: <a href="' + FRONTEND_URL + '/zoho-crm" target="_blank">Open CRM</a>', 'info');
            } else {
                addResult('‚ùå Some tests failed. Check the errors above.', 'error');
            }
        }

        // Auto-run basic test on page load
        window.onload = function() {
            addResult('üöÄ Zoho CRM Connection Tester Ready', 'info');
            addResult(`üìç Frontend: ${FRONTEND_URL}`, 'info');
            addResult(`üìç Backend: ${BACKEND_URL}`, 'info');
            addResult('Click "Test Complete Flow" to run all tests', 'info');
        };
    </script>
</body>
</html>